let textarea=document.getElementById("message"),currentUserElement=document.getElementById("btn-chat-all"),messageElm=document.getElementById("messages");function loadMessage(e,t){let s=new XMLHttpRequest;s.onload=function(){if(s.status>=200&&s.status<300){let t=JSON.parse(s.response);e.lastMessages instanceof Array==!1&&(e.lastMessages=[]);for(let s=0;s<t.messages.length;++s){const a=t.messages[s];e.lastMessages.unshift({text:a.text,from:{id:a.from.id,displayName:a.from.firstname+" "+a.from.lastname},to:a.to})}userPressed(e)}else console.log("request failed")};let a=messagesElm.getAttribute("data-action");t&&(a+="?fromId="+t),e.lastMessages instanceof Array==!0&&(-1===a.indexOf("?")?a+="?":a+="&",a+="offset="+e.lastMessages-length),s.open("GET",a),s.setRequestHeader("Content-Type","application/jason"),s.send()}function updateUserBtnName(e){e.innerText=e.getAttribute("data-fullname"),"0"!==e.getAttribute("data-new")&&(e.innerText+=" ("+e.getAttribute("data-new")+")")}function userPressed(e){if(currentUserElm=e,e.setAttribute("data-new","0"),updateUserBtnName(e),document.getElementById("messages").innerHTML="",e.lastMessages)for(let t=0;t<e.lastMessages.length;++t){handleIncomingMessage(e.lastMessages[t])}else{let t=e.getAttribute("data-id");loadMessages(e,"0"===t?null:t)}}function sendPressed(e){console.log("send Message");let t=document.getElementById("message"),s={text:t.value};t.value="","0"!==currentUserElm.getAttribute("data-id")&&(s.toId=parseInt(currentUserElm.getAttribute("data-id"))),io.emit("message",s)}function handleIncomingMessage(e){let t=document.getElementById("message"),s=null;if(e.to?currentUserId!==e.from.id&&currentUserElm.getAttribute("data-id")!=e.fromid&&(s=e.from.id):"0"!==currentUserElm.getAttribute("data-id")&&(s="all"),null!==s){let t=document.getElementById("btn-chat-"+s);if(t){let s=parseInt(t.getAttribute("data-new"))+1;t.setAttribute("data-new",s),t.lastMessages&&t.lastMessages.push(e),updateUserBtnName(t)}}else{let s=document.createElement("DIV");s.innerText=e.from.displayName+": "+e.text,t.appendChild(s),t.scrollTop=t.scrollHeight}}io.on("message",e=>{console.log("incoming message"),handleIncomingMessage(e)}),messageElm.addEventListener("scroll",function(){if(0===this.scrollTop){let e=currentUserElm.getAttribute("data-id");loadMessages(currentUserElm,"0"===e?null:e)}}),textarea.altActive=!1,textarea.addEventListener("keydown",function(e){18===e.keyCode&&(textarea.altActive=!0)}),textarea.addEventListener("keyup",function(e){18===e.keyCode&&(textarea.altActive=!1),13===e.keyCode&&!1===textarea.altActive?sendPressed():13===e.keyCode&&!0===textarea.altActive&&(textarea.value+="\n")}),loadMessages(currentUserElm);